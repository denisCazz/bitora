---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import CookieBanner from '../components/CookieBanner.astro';
import Analyticsgoogle from '../components/Analyticsgoogle.astro';
import PerformanceMonitorSimple from '../components/PerformanceMonitorSimple.astro';
import PerformanceOptimizer from '../components/PerformanceOptimizer.astro';
import '../styles/global.css';
import  SpeedInsights  from "@vercel/speed-insights/astro"
import Analytics from '@vercel/analytics/astro'

export interface Props {
  title: string;
  description?: string;
}

const { title, description } = Astro.props;
// Costruisci l'URL canonico corretto - pi√π robusto
const pathname = Astro.url.pathname || '/';
const canonicalUrl = pathname === '/' 
  ? 'https://www.bitora.it/' 
  : `https://www.bitora.it${pathname.endsWith('/') ? pathname : pathname + '/'}`;
---

<!doctype html>
<html lang="it" class="dark">
  <head>
    <meta charset="UTF-8" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17047013851">
    </script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'AW-17047013851');
    </script>
    <meta name="trustpilot-one-time-domain-verification-id" content="a73b7189-4327-406d-9010-8bc27db1d6c1"/>
    <SpeedInsights/>
    <Analytics />
    <!-- Performance Optimizer - Critical Resources -->
    <PerformanceOptimizer />
    
    <!-- Analytics (caricato condizionalmente) -->
    <Analyticsgoogle />
    
    <!-- Performance Monitoring -->
    <PerformanceMonitorSimple />
    
    <!-- Analytics - Load conditionally based on consent -->
    <script is:inline>
      // Check cookie consent before loading analytics
      function getCookieConsent() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'bitora_cookie_consent') {
            try {
              return JSON.parse(decodeURIComponent(value));
            } catch (e) {
              return null;
            }
          }
        }
        return null;
      }
      
      // Load analytics script only if consent given
      function loadAnalyticsScript() {
        const consent = getCookieConsent();
        if (consent && consent.analytics) {
          // Check if script is already loaded
          if (!document.querySelector('script[data-website-id="2adbf0f8-a9d3-47bd-9a32-61ac932f9640"]')) {
            const script = document.createElement('script');
            script.defer = true;
            script.src = 'https://cloud.umami.is/script.js';
            script.setAttribute('data-website-id', '2adbf0f8-a9d3-47bd-9a32-61ac932f9640');
            document.head.appendChild(script);
          }
        }
      }
      
      // Initial load
      document.addEventListener('DOMContentLoaded', loadAnalyticsScript);
      
      // Listen for consent changes
      window.addEventListener('cookieConsentChanged', loadAnalyticsScript);
    </script>
    <!-- Essential Meta -->
    <meta name="generator" content={Astro.generator} />

    <!-- SEO -->
    <title>{title}</title>    <meta
      name="description"
      content={description ??
        'Soluzioni digitali professionali per aziende moderne. Bitora crea ecosistemi web e tecnologie NFC innovative per la crescita del business.'}
    />
    <link rel="canonical" href={canonicalUrl} />

    <!-- Geo Tags per SEO locale -->
    <meta name="geo.region" content="IT-21" />
    <meta name="geo.placename" content="Carmagnola" />
    <meta name="geo.position" content="44.8477;7.6833" />
    <meta name="ICBM" content="44.8477, 7.6833" />
    <meta name="keywords" content="soluzioni digitali, web design professionale, tecnologie NFC, ecosistemi digitali, sviluppo web, landing page, performance digitale" />
    
    <style is:global>
      :root {
        --color-bg: #000000;
        --color-text: #ffffff;
      }
      
      html {
        background-color: var(--color-bg);
        color: var(--color-text);
        scroll-behavior: smooth;
      }

      body {
        margin: 0;
        padding: 0;
        overflow-x: hidden;
      }

      /* Apple-style Reveal Animation */
      .reveal-on-scroll {
        opacity: 0;
        transform: translateY(30px);
        transition: all 1s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .reveal-on-scroll.is-visible {
        opacity: 1;
        transform: translateY(0);
      }

      /* Fade In Up Animation */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fade-in-up {
        animation: fadeInUp 0.8s ease-out forwards;
      }
    </style>

    <script>
      // Global Intersection Observer for Reveal Animations
      const observerOptions = {
        root: null,
        rootMargin: '0px',
        threshold: 0.1
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            observer.unobserve(entry.target);
          }
        });
      }, observerOptions);

      document.addEventListener('astro:page-load', () => {
        const elements = document.querySelectorAll('.reveal-on-scroll');
        elements.forEach(el => observer.observe(el));
      });

      // Fallback for initial load if View Transitions are not used or for first paint
      document.addEventListener('DOMContentLoaded', () => {
        const elements = document.querySelectorAll('.reveal-on-scroll');
        elements.forEach(el => observer.observe(el));
      });
    </script>
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" href="/bitora.png" />

    <!-- Fonts with optimized loading - non-blocking -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      as="style"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      media="print"
      onload="this.media='all'"
    />
    <noscript
      ><link
        rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      /></noscript
    >

    <!-- Sitemap -->
    <link rel="sitemap" href="/sitemap-index.xml" />    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.bitora.it/" />
    <meta property="og:title" content={title} />
    <meta
      property="og:description"
      content={description ??
        'Soluzioni digitali professionali per aziende moderne. Bitora realizza ecosistemi web e tecnologie NFC innovative per la crescita del business.'}
    />
    <meta property="og:image" content="https://www.bitora.it/bitora.jpg" />
    <meta property="og:locale" content="it_IT" />
    <meta property="og:site_name" content="Bitora - Soluzioni Digitali Professionali" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="https://www.bitora.it/" />
    <meta name="twitter:title" content={title} />
    <meta
      name="twitter:description"
      content={description ??
        'Soluzioni digitali professionali per aziende moderne. Bitora realizza ecosistemi web e tecnologie NFC innovative per distinguersi online.'}
    />
    <meta name="twitter:image" content="https://www.bitora.it/bitora.jpg" />

    <!-- Structured Data -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "Bitora",
        "url": "https://www.bitora.it",
        "logo": "https://www.bitora.it/bitora.png",
        "sameAs": [
          "https://www.instagram.com/bitorait/",
          "https://www.facebook.com/people/Bitora-Italia/pfbid0JubiVqBfxyM2nY6CoHLW3P5vQkjhUGE5UF5Pa16f491fzGsneW512MdMTiEpgvJCl/?mibextid=wwXIfr&rdid=xyslEd78VfiU5dPK&share_url=https%3A%2F%2Fwww.facebook.com%2Fshare%2F1BTziLdEef%2F%3Fmibextid%3DwwXIfr"
        ]
      }
    </script>

    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "url": "https://www.bitora.it/",
        "potentialAction": {
          "@type": "SearchAction",
          "target": "https://www.bitora.it/?s={search_term_string}",
          "query-input": "required name=search_term_string"
        }
      }    </script>
  </head>
  <body class="flex flex-col min-h-screen font-['Inter',sans-serif] transition-colors duration-300" style="background-color: var(--bg-primary); color: var(--text-primary);">
    <Header />
    <main id="main-content" class="flex-grow" tabindex="-1">
      <slot />
    </main>
    <Footer />
    
    <!-- Back to Top Button -->
    <button 
      id="back-to-top" 
      class="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 z-50 bg-primary hover:bg-primary-600 text-white p-2 sm:p-3 rounded-full shadow-lg transition-all duration-300 opacity-0 invisible hover:scale-110 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
      aria-label="Torna in cima"
    >
      <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
      </svg>
    </button>

    <script>
      // Back to Top functionality
      const backToTopButton = document.getElementById('back-to-top');
      
      if (backToTopButton) {
        // Show/hide button based on scroll position
        function toggleBackToTop() {
          if (window.scrollY > 300) {
            backToTopButton.classList.remove('opacity-0', 'invisible');
            backToTopButton.classList.add('opacity-100', 'visible');
          } else {
            backToTopButton.classList.add('opacity-0', 'invisible');
            backToTopButton.classList.remove('opacity-100', 'visible');
          }
        }
        
        // Smooth scroll to top
        function scrollToTop() {
          window.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
        }
        
        // Add event listeners
        window.addEventListener('scroll', toggleBackToTop);
        backToTopButton.addEventListener('click', scrollToTop);
        
        // Initial check
        toggleBackToTop();
      }
    </script>
    <CookieBanner />
  </body>
</html>
